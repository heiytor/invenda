worker_processes  2;
user              nginx;

events {
    use                 epoll;
    multi_accept        on;
    worker_connections  128;
}

http {
    include                   mime.types;
                              
    server_tokens             off;
    charset                   utf-8;
                              
    client_body_temp_path     /var/run/nginx/nginx-client-body;
    proxy_temp_path           /var/run/nginx/nginx-proxy;
                              
    aio                       threads;
    aio_write                 on;
                              
    tcp_nopush                on;
    tcp_nodelay               on;
                              
    sendfile                  on;

    reset_timedout_connection on;

    gzip                      on;
    gzip_comp_level           1;
    gzip_http_version         1.1;
    gzip_min_length           256;
    gzip_types                application/atom+xml application/javascript application/x-javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/javascript text/plain text/x-component;
    gzip_proxied              any;
    gzip_vary                 on;

    server {
        server_name   localhost;
        listen        80;
        resolver      127.0.0.11 ipv6=off;

        location      /healthcheck {
            return 200 "";
        }

        location      /api/ {
            set $upstream api:8080;
            rewrite ^/api/(.*)$ /public/$1 break; # redirect to /public/{...path}

            proxy_pass http://$upstream;
        }

        location      /docs/openapi {
            set $upstream openapi:8080;
            rewrite ^/docs/openapi/?(.*)$ /$1 break;

            proxy_pass http://$upstream;
        }
    }
}
